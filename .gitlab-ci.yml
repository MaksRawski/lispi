# https://github.com/mozilla/grcov#grcov-with-gitlab
build:
  variables:
    LLVM_PROFILE_FILE: "target/coverage/%p-%m.profraw"
  script:
    - cargo test
    - mkdir target/coverage
    - grcov target/coverage --binary-path target/debug -s . -o target/coverage --keep-only 'src/*' --output-types html,cobertura
    - xmllint --xpath "concat('Coverage:', 100 * string(//coverage/@line-rate), '%')" target/coverage/cobertura.xml

  coverage: '/Coverage:\d+(?:\.\d+)?/'
  artifacts:
    paths:
      - target/coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: target/coverage.xml
