# https://github.com/mozilla/grcov#grcov-with-gitlab
image: rust:1.70

stages:
  - test

test:coverage:
  cache:
    key:
      files:
        - Cargo.toml
    paths:
      - $CARGO_HOME
  variables:
    LLVM_PROFILE_FILE: "target/coverage/%p-%m.profraw"
  before_script:
    - rustup component add llvm-tools-preview
    - cargo install grcov
  script:
    - cargo test -j 1
    - mkdir -p target/coverage
    - grcov target/coverage --binary-path target/debug -s . -o target/coverage --keep-only 'src/*' --output-types html,cobertura
    - xmllint --xpath "concat('Coverage:', 100 * string(//coverage/@line-rate), '%')" target/coverage/cobertura.xml

  coverage: '/Coverage:\d+(?:\.\d+)?/'
  artifacts:
    paths:
      - target/coverage/
    reports:
      coverage_report:
        coverage_format: cobertura
        path: target/coverage.xml
